---
- name: "Create Directory"
  file:
    path: ~/backend-app
    state: directory

- name: "Unarchive Artifact"
  unarchive:
    src: /home/artifact.tar.gz
    dest: ~/backend-app/

- name: "Install Deployment"
  command: |
      sudo apt update
      sudo apt install curl -y

      sudo apt update
      curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
      sudo apt-get install -y nodejs
      sudo npm install -g n
      sudo n 13.8.0

      sudo apt update
      sudo apt install --yes software-properties-common
      sudo add-apt-repository --yes --update ppa:ansible/ansible
      sudo apt install ansible --yes

      cd ~/backend-app
      npm install typescript -g
      npm i

- name: "Exec PM2"
  command: |
      sudo npm install pm2
      cd ~/backend-app/dist
      pm2 stop default
      pm2 start main.js
      
- name: "PM2 as a service"
  shell: |
      sudo su -c "env PATH:$PATH:/usr/local/bin pm2 startup systemd -u ubuntu --hp /home/ubuntu"
      pm2 save